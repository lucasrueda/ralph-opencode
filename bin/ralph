#!/usr/bin/env bash
#
# Ralph - Autonomous AI Agent for OpenCode
# Iteratively implements PRD stories until all are complete
#
# Usage: ralph [options]
#   -m, --model MODEL        Model to use (or 'select' to choose interactively)
#   -n, --max-iterations N   Maximum iterations (default: 10)
#   -p, --prd FILE           Path to prd.json (default: ./prd.json)
#   -d, --dry-run            Show what would be done without executing
#   -h, --help               Show this help message
#

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Default values
MAX_ITERATIONS=10
PRD_FILE="./prd.json"
DRY_RUN=false
MODEL=""

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -m|--model)
            MODEL="$2"
            shift 2
            ;;
        -n|--max-iterations)
            MAX_ITERATIONS="$2"
            shift 2
            ;;
        -p|--prd)
            PRD_FILE="$2"
            shift 2
            ;;
        -d|--dry-run)
            DRY_RUN=true
            shift
            ;;
        -h|--help)
            head -15 "$0" | tail -11
            exit 0
            ;;
        *)
            echo -e "${RED}Unknown option: $1${NC}"
            exit 1
            ;;
    esac
done

# Interactive model selection
select_model() {
    echo -e "${BLUE}Fetching available models...${NC}"
    
    local models
    models=$(opencode models 2>/dev/null)
    
    if [[ -z "$models" ]]; then
        echo -e "${RED}Failed to fetch models. Is OpenCode configured?${NC}"
        exit 1
    fi
    
    # Convert to array
    local model_array=()
    while IFS= read -r line; do
        [[ -n "$line" ]] && model_array+=("$line")
    done <<< "$models"
    
    local total=${#model_array[@]}
    
    echo ""
    echo -e "${GREEN}Available models (${total} total):${NC}"
    echo ""
    
    # Show models with numbers
    local i=1
    for model in "${model_array[@]}"; do
        printf "  %3d) %s\n" "$i" "$model"
        ((i++))
    done
    
    echo ""
    read -rp "Select model number (1-${total}): " selection
    
    # Validate selection
    if ! [[ "$selection" =~ ^[0-9]+$ ]] || [[ "$selection" -lt 1 ]] || [[ "$selection" -gt "$total" ]]; then
        echo -e "${RED}Invalid selection${NC}"
        exit 1
    fi
    
    MODEL="${model_array[$((selection-1))]}"
    echo ""
    echo -e "${GREEN}Selected: ${YELLOW}${MODEL}${NC}"
    echo ""
}

# Handle model selection if requested
if [[ "$MODEL" == "select" ]]; then
    select_model
fi

# Check dependencies
check_dependencies() {
    local missing=()
    command -v jq &> /dev/null || missing+=("jq")
    command -v opencode &> /dev/null || missing+=("opencode")
    command -v git &> /dev/null || missing+=("git")
    
    if [[ ${#missing[@]} -gt 0 ]]; then
        echo -e "${RED}Missing dependencies: ${missing[*]}${NC}"
        echo "Please install them and try again."
        exit 1
    fi
}

# Check if PRD file exists
check_prd() {
    if [[ ! -f "$PRD_FILE" ]]; then
        echo -e "${RED}PRD file not found: $PRD_FILE${NC}"
        echo ""
        echo "To get started, create a prd.json file:"
        echo "  1. Run: opencode \"/generate-prd <your project description>\""
        echo "  2. Run: opencode \"/convert-to-json\""
        echo "  3. Run: ralph"
        exit 1
    fi
}

# Get count of incomplete stories
get_incomplete_count() {
    jq '[.userStories[] | select(.passes == false)] | length' "$PRD_FILE"
}

# Get total story count
get_total_count() {
    jq '.userStories | length' "$PRD_FILE"
}

# Get project name
get_project_name() {
    jq -r '.project // "Unknown Project"' "$PRD_FILE"
}

# Check if all stories are complete
all_complete() {
    local incomplete
    incomplete=$(get_incomplete_count)
    [[ "$incomplete" -eq 0 ]]
}

# Print status banner
print_banner() {
    local iteration=$1
    local incomplete=$2
    local total=$3
    local project=$4
    
    echo ""
    echo -e "${BLUE}╔══════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${BLUE}║${NC}  ${GREEN}RALPH${NC} - Autonomous AI Agent                                ${BLUE}║${NC}"
    echo -e "${BLUE}╠══════════════════════════════════════════════════════════════╣${NC}"
    echo -e "${BLUE}║${NC}  Project:    ${YELLOW}$project${NC}"
    echo -e "${BLUE}║${NC}  Iteration:  ${YELLOW}$iteration / $MAX_ITERATIONS${NC}"
    echo -e "${BLUE}║${NC}  Progress:   ${YELLOW}$((total - incomplete)) / $total${NC} stories complete"
    echo -e "${BLUE}╚══════════════════════════════════════════════════════════════╝${NC}"
    echo ""
}

# Main loop
main() {
    check_dependencies
    check_prd
    
    local project
    project=$(get_project_name)
    
    echo -e "${GREEN}Starting Ralph...${NC}"
    echo -e "PRD: ${YELLOW}$PRD_FILE${NC}"
    echo -e "Max iterations: ${YELLOW}$MAX_ITERATIONS${NC}"
    [[ -n "$MODEL" ]] && echo -e "Model: ${YELLOW}$MODEL${NC}"
    
    # Initialize progress.txt if it doesn't exist
    if [[ ! -f "progress.txt" ]]; then
        echo "# Ralph Progress Log" > progress.txt
        echo "# Auto-generated by Ralph" >> progress.txt
        echo "" >> progress.txt
    fi
    
    local iteration=1
    
    while [[ $iteration -le $MAX_ITERATIONS ]]; do
        local incomplete total
        incomplete=$(get_incomplete_count)
        total=$(get_total_count)
        
        print_banner "$iteration" "$incomplete" "$total" "$project"
        
        # Check if all stories are complete
        if all_complete; then
            echo -e "${GREEN}All stories complete! Ralph is done.${NC}"
            echo ""
            echo -e "Progress log: ${YELLOW}progress.txt${NC}"
            exit 0
        fi
        
        # Build opencode command
        local opencode_cmd="opencode run"
        [[ -n "$MODEL" ]] && opencode_cmd="$opencode_cmd -m $MODEL"
        opencode_cmd="$opencode_cmd \"/ralph\""
        
        if [[ "$DRY_RUN" == true ]]; then
            echo -e "${YELLOW}[DRY RUN]${NC} Would execute: $opencode_cmd"
            echo ""
            exit 0
        fi
        
        # Run OpenCode with Ralph skill
        echo -e "${BLUE}Running OpenCode...${NC}"
        echo ""
        
        if ! eval "$opencode_cmd"; then
            echo -e "${RED}OpenCode exited with error. Stopping Ralph.${NC}"
            exit 1
        fi
        
        ((iteration++))
        
        # Small delay between iterations
        sleep 2
    done
    
    echo -e "${YELLOW}Max iterations ($MAX_ITERATIONS) reached.${NC}"
    echo -e "Incomplete stories: ${RED}$(get_incomplete_count)${NC}"
    echo ""
    echo "Run 'ralph' again to continue, or increase max iterations with -n flag."
    exit 1
}

main "$@"
